---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r include=FALSE}
library(ggplot2)
library(reshape2)
library(stringr)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
data = read.table("/mnt/raid64/ATS/Personal/zhangyiming/peaks.txt", sep = "\t", header = T)

rownames(data) = seq(-nrow(data) / 2 + 1, nrow(data)/2)

temp = apply(data, 2, function(col) {
    col / sum(col)
})


temp = melt(as.matrix(temp))
temp = temp[temp$Var2 != "CTCF", ]
peaks = temp
peaks$source = "ATS"
```


```{R}
ggplot(temp, aes(x=Var1, y=value, color=Var2)) +
    geom_line() +
    facet_wrap(.~Var2)
```


```{r pressure, echo=FALSE}
data = read.table("/mnt/raid64/ATS/Personal/zhangyiming/cage_sel.txt", sep = "\t", header = T)

rownames(data) = seq(-nrow(data) / 2 + 1, nrow(data)/2)

# temp = apply(data, 2, function(col) {
#     col / sum(col) * 10â€º
# })
temp = data

temp = melt(as.matrix(temp))
temp = temp[temp$Var2 != "CTCF", ]
peaks = temp
peaks$source = "ATS"
```


```{R}
ggplot(temp, aes(x=Var1, y=value, color=Var2)) +
    geom_line() +
    facet_wrap(.~Var2)
```


```{r pressure, echo=FALSE}
data = read.table("/mnt/raid64/ATS/Personal/zhangyiming/cage.txt", sep = "\t", header = T)

rownames(data) = seq(-nrow(data) / 2 + 1, nrow(data)/2)

# temp = apply(data, 2, function(col) {
#     col / sum(col)
# })
temp = data

temp = melt(as.matrix(temp))
temp = temp[temp$Var2 != "CTCF", ]
temp$source = "CAGE"
peaks = rbind(peaks, temp)
```


```{R}
ggplot(temp, aes(x=Var1, y=value, color=Var2)) +
    geom_line() +
    facet_wrap(.~Var2)
```


```{r}
for (i in unique(peaks$Var2)) {
    p <- ggplot(peaks[peaks$Var2 == i, ], aes(x=Var1, y=value, color=source)) +
        geom_line() +
        labs(title = i, x = "Distance to TSS (bp)", y="Average Cov")
    print(p)
}
```


```{r pressure, echo=FALSE}
data = read.table("/mnt/raid64/ATS/Personal/zhangyiming/promoter.txt", sep = "\t", header = T)

rownames(data) = seq(-nrow(data) / 2 + 1, nrow(data)/2)

# temp = apply(data, 2, function(col) {
#     col / sum(col)
# })
temp = data

temp = melt(as.matrix(temp))
temp = temp[temp$Var2 != "CTCF", ]
temp$source = "Annotation"
# peaks = rbind(peaks, temp)
```


```{R}
ggplot(temp, aes(x=Var1, y=value, color=Var2)) +
    geom_line() +
    facet_wrap(.~Var2)
```


## compare different standard

```{r}
fs = list.files("/mnt/raid64/ATS/Personal/zhangyiming/cage_sel_hm/",  pattern = "_.txt", full.names = T)

peaks = NULL
for (f in fs) {
    key = str_replace_all(basename(f), "(peak_region_|_.txt)", "")
    key = str_split(key, "_")[[1]]
    data = read.table(f, sep = "\t", header = T)

    rownames(data) = seq(-nrow(data) / 2 + 1, nrow(data)/2)
    temp = melt(as.matrix(data))
    temp = temp[temp$Var2 != "CTCF", ]
    temp$freq = as.numeric(key[1])
    temp$count  = as.numeric(key[2])
   
    peaks = rbind(peaks, temp)
}
```


```{r fig.height=10, fig.width=10}
for (i in unique(peaks$Var2)) {
    p <- ggplot(peaks[peaks$Var2 == i, ], aes(x=Var1, y=value, color = Var2)) +
        geom_line() + labs(title = i) +
        facet_grid(freq~count)
    print(p)
}
```


```{R}
test_xu <- read.delim("/mnt/raid64/ATS/Personal/zhangyiming/NHC2")

data = test_xu[test_xu$alpha_arr != "", ]
len_list = vector('list',length=nrow(test_xu))
for(i in seq(nrow(test_xu))){
  st_arr = as.numeric(strsplit(as.character(test_xu[i,'st_arr']),',')[[1]])
  en_arr = as.numeric(strsplit(as.character(test_xu[i,'en_arr']),',')[[1]])
  len_list[[i]] = st_arr-en_arr
}
len_arr = unlist(len_list)
plot.new()
plot(density(abs(len_arr)),title('fragment size distribution'),xlim=c(0,500))

```


```{r pressure, echo=FALSE}
data = read.table("/mnt/raid64/ATS/Personal/zhangyiming/peaks/NHC2", sep = "\t", header = T)

rownames(data) = seq(-nrow(data) / 2 + 1, nrow(data)/2)

# temp = apply(data, 2, function(col) {
#     col / sum(col)
# })
temp = data

temp = melt(as.matrix(temp))
temp = temp[temp$Var2 != "CTCF", ]
temp$source = "Annotation"
# peaks = rbind(peaks, temp)
```


```{R}
ggplot(temp, aes(x=Var1, y=value, color=Var2)) +
    geom_line() +
    facet_wrap(.~Var2)
```


```{R}
test_xu <- read.delim("/mnt/raid64/ATS/Personal/zhangyiming/NHC2_jl")

data = test_xu[test_xu$alpha_arr != "", ]
len_list = vector('list',length=nrow(test_xu))
for(i in seq(nrow(test_xu))){
  st_arr = as.numeric(strsplit(as.character(test_xu[i,'st_arr']),',')[[1]])
  en_arr = as.numeric(strsplit(as.character(test_xu[i,'en_arr']),',')[[1]])
  len_list[[i]] = st_arr-en_arr
}
len_arr = unlist(len_list)
len_arr = len_arr[abs(len_arr)> 10]
plot.new()
plot(density(abs(len_arr)),title('fragment size distribution'),xlim=c(0,500))

```

```{r pressure, echo=FALSE}
data = read.table("/mnt/raid64/ATS/Personal/zhangyiming/peaks/NHC2_jl_all", sep = "\t", header = T)

rownames(data) = seq(-nrow(data) / 2 + 1, nrow(data)/2)

# temp = apply(data, 2, function(col) {
#     col / sum(col)
# })
temp = data

temp = melt(as.matrix(temp))
temp = temp[temp$Var2 != "CTCF", ]
temp$source = "Annotation"
# peaks = rbind(peaks, temp)
```


```{R}
ggplot(temp, aes(x=Var1, y=value, color=Var2)) +
    geom_line() +
    facet_wrap(.~Var2, scales = "free")
```


```{r}
read_data <- function(path, region) {
  library(stringr)
  
  test_xu <- read.delim(path)

  # data = test_xu[test_xu$alpha_arr != "", ]
  
  data = data[str_detect(as.character(test_xu$utr), region), ]
  
  res = list()
  for (i in colnames(data)) {
    temp = data[1, i]
    print(temp)
    if(str_detect(temp, ":")) {
      res[[i]] = temp
    } else if (str_detect(temp, ",")) {
      res[[i]] = sapply(str_split(temp, ",")[[1]], function(x) { as.numeric(x) })
    } else {
      res[[i]] = as.numeric(temp)
    }
  }
  res
}

res = read_data("/mnt/raid64/ATS/Personal/zhangyiming/infered/NHC2_R.txt", "1:6205375-6206201:+")

plot.new()
plot(density(res$st_arr),col='red')
lines(density(res$en_arr),col='blue')
abline(v=res$alpha_arr,col='green')
legend('topleft',legend=c('l','r','est_l'),lty=c(1,1,1),col=c('red','blue','green'))
```


```{R}
set.seed(2)
atsmix(n_max_ats = 4, n_min_ats=1, st_arr = res$st_arr , en_arr=res$en_arr, 
             L = abs(6205375 - 6206201),
             mu_f=300, # fragment length mean
             sigma_f=50, # fragment length standard deviation

             # pa site information
             min_ws = 0.01, # minimum weight of ATS site

             # inference with fixed parameters
             fixed_inference_flag = FALSE,

             #single end mode
             single_end_mode = FALSE,
             debug=F)

```

```{r}
st_arr = c(
-457,-437,-441,-433,-433,-433,-431,-433,-433,-433,-433,
-426,-426,-426,-426,-426,-424,-424,-424,-424,-433,-424,
-433,-441,-441,-433,-432,-432,-411,-411,-416,-441,-441,
-404,-409,-413,-408,-408,-408,-408,-408,-408,-406,-406,
-426,-398,-424,-398,-402,-433,-424,-426,-437,-409,-426,
-429,-433,-441,-416,-413,-413,-408,-408,-431,-408,-432,
-426,-431,-424,-424,-408,-433,-426,-437,-424,-433,-429,
-441,-426,-426,-423,-426,-429,-424,-424,-408,-426,-413,
-433,-428,-424,-408,-408,-432,-426,-402,-426,-426,-409,
-402,-409,-440,-424,-424,-419,-419,-441,-424,-423,-426,
-424,-426,-426,-404,-430,-419,-413,-431,-413,-408,-433,
-455,-404,-402,-424,-408,-409,-408,-411,-433,-404,-424,
-402,-428,-426,-426,-404,-433,-408,-408,-424,-398,-433,
-455,-426,-433,-433,-408,-408,-423,-411,-408,-426,-411,
-441,-419,-426,-428,-411,-404,-440,-413,-457,-429,-432,
-404,-424,-408,-413,-429,-431,-411,-413,-432,-413,-433,
-423,-429,-404,-408,-433,-408,-424,-408,-419,-408,-408,
-424,-435,-424,-408,-424,-424,-411,-413,-426,-408,-403,
-411,-457,-441,-408,-419,-429,-402,-408,-408,-419,-408,
-426,-426,-395,-433,-428,-432,-402,-417,-433,-434,-413,
-419,-411,-408,-433,-432,-429,-402,-433,-402,-411,-433,
-433,-408,-424,-428,-408,-428,-426,-432,-419,-437,-433,
-433,-402,-408,-410,-411,-408,-413,-425,-408,-408,-413,
-402,-424,-424,-432,-426,-424,-432,-424,-424,-408,-419,
-426,-402,-419,-411,-433,-432,-413,-417,-427,-413,-394,
-424,-424,-408,-408,-433,-433,-413,-414,-408,-455,-426,
-408,-424,-426,-433,-408,-419,-426,-432,-424,-413,-426,
-398,-426,-408,-410,-411,-408,-424,-437,-419,-408,-410,
-408,-417,-433,-408,-413,-424,-426,-416,-428,-404,-424,
-434,-410,-434,-404,-411,-424,-433,-403,-408,-424,-424,
-426,-433,-429,-429,-424,-408,-408,-402,-408,-432,-424,
-437,-404,-411,-432,-426,-426,-424,-424,-457,-426,-426,
-420,-429,-419,-426,-419,-433,-423,-424,-408,-408,-408,
-408,-415,-402,-408,-411,-433,-429,-424,-431,-429,-424,
-426,-433,-429,-408,-402,-432,-424,-411,-408,-408,-413,
-423,-429,-408,-413,-398,-426,-424,-408,-411,-434,-408,
-424,-426,-423,-426,-426,-402,-428,-434,-424,-426,-408,
-404,-408,-437,-433,-408,-408,-411,-408,-426,-426,-424,
-424,-428,-440,-433,-424,-424,-413,-424,-424,-441,-433,
-429,-437,-437,-424,-411,-415,-419,-413,-441,-426,-432,
-413,-433,-434,-424,-432,-426,-419,-408,-424,-426,-426,
-408,-424,-426,-426,-457,-413,-432,-408,-408,-408,-436,
-404,-421,-433,-413,-419,-426,-408,-408,-433,-398,-408,
-455,-433,-408,-419,-408,-426,-423,-424,-433,-404,-433,
-402,-402,-437,-433,-433,-408,-433,-419,-402,-408,-403,
-439,-426,-413,-413,-407,-413,-433,-404,-428,-433,-433,
-457,-408,-424,-413,-408,-408,-411,-408,-419,-413,-424,
-408,-424,-434,-408,-424,-437,-408,-408,-441,-402,-416,
-416,-413,-428,-402,-417,-398,-419,-408,-408,-408,-426,
-426,-419,-419,-419,-408,-424,-406,-408,-408,-402,-433,
-408,-424,-408,-433,-428,-433,-433,-423,-408,-408,-431,-416,-419,-408,-431,-433,-433,-433,-411,-419,-419,-426,-424,-419,-413,-402,-413,-429,-411,-404,-415,-434,-404,-424,-411,-416,-419,-408,-433,-424,-408,-433,-424,-408,-413,-441,-433,-424,-417,-421,-419,-424,-426,-436,-408,-408,-424,-411,-419,-432,-428,-402,-408,-408,-424,-424,-433,-411,-408,-408,-408,-419,-428,-428,-413,-408,-411,-433,-413,-424,-408,
-408,-408,-408,-426,-411,-404,-408,-411,-457,-404,-411,-419,-408,
-415,-413,-409,-424,-408,-408,-408,-411,-408,-405,-419,-429,-408,-419,-402,-413,-428,-426,-402,-408,-408,-429,-424,-433,-408,-423,-411,-408,-408,-424,-424,-416,-413,-419,-429,-408,-413,-416,-413,-413,-433,-402,-408,-404,-419,-402,-424,-424,-433,-433,-413,-426,-411,-408,-410,-413,-408,-424,-408,
-408,-408,-426,-426,-419,-408,-416,-426,-401,-417,-404,-419,-433,-424,-408,-408,-413,-413,-429,-408,-433,-413,-402,-424,-404,-410,-408,-424,-405,-411,-411,-408,-433,-417,-432,-429,-440,-441,-409,-413,-404,-408,-419,-408,-408,-413,-402,-427,-429,-416,-408,-432,-432,-413,-419,-424,-408,-413,-424,-439,-413,-429,-433,-408,-424,-408,-413,-413,-403,-411,-424,-433,-428,-413,-310,-313,-411,-434,-408,-408,-404,-408,-408,-424,-433,-433,-426,-409,-432,-408,-408,-408,-408,-408,-408,-431,-413,-408,-408,-408,-408,-408,-431,-404,-413,-411,-408,-408,-426,-411,-408,-432,-413,-408,-424,-416,-404,-424,-424,-433,-408,-433,-408,-426,-408,-398,-408,-413,-426,-411,-402,-404,-424,-408,-404,-428,-410,-424,-424,-408,-408,-413,-408,-408,-408,-417,-426,-403,-408,-429,-424,-424,-413,-411,-423,-413,-426,-409,-408,-408,-411,-408,-411,-408,-402,-419,-408,-408,-413,-408,-398,-433,-408,-433,-426,-413,-408,-402,-426,-411,-408,-428,-424,-402,-402,-404,-404,-408,-395,-413,-426,-408,-429,-413,-441,-416,-402,-424,-408,-413,-426,-426,-408,-429,-413,-408,-426,-408,-411,-410,-404,-402,-408,-406,-402,-413,-408,-393,-408,
-413,-433,-424,-405,-408,-408,-413,-413,-408,-408,-402,-402,-428,-413,-408,-408,-414,-424,-404,-417,
-411,-426,-403,-410,-410,-424,-419,-424,-395,-402,-404,-408,-408,-411,-313,-408,-408,-402,-413,-402,-408,-404,-408,-424,-426,-403,-403,-408,-408,-408,-408,-441,-402,-404,-426,-426,
-413,-402,-399,-413,-408,-402,-413,-410,-402,-408,-402,-403,-403,-408,-402,-404,-411,-413,-419,-408,-411,-398,-408,-426,-408,-408,-408,-402,-408,-404,-408,-408,-411,-402,-433,-408,-426,-429,-408,-429,-408,-411,-408,-424,-408,-408,-359,-413,-408,-408,-413,-404,-411,-405,-431,-408,-433,-417,-402,-408,-402,-408,-408,-424,-398,-410,-404,-406,-408,-374,-402,-402,-405,-402,-439,-402,-406,-402,-405,-408,-404)


plot(density(st_arr, bw="SJ"))
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
