---
title: "Seurat"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r include=FALSE}
library(Seurat)
library(data.table)
library(stringr)
library(openxlsx)
library(Matrix)
library(trqwe)
library(ggplot2)
library(doMC)
library(ComplexHeatmap)
library(circlize)
library(dplyr)
library(ggrastr)
library(ggrepel)
library(ComplexHeatmap)
library(circlize)
library(ICAS)
```

## Including Plots

```{r pressure, echo=FALSE}
fs = list.files("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/", pattern = "psi$", full.names = T)

data = NULL
for (f in fs) {
    key = str_replace_all(basename(f), ".quant", "")
    
    if (str_detect(key, "bak")) {
        next
    }
    
    print(key)
    temp = fread(f)
    temp = as.data.frame(temp)
    rownames(temp) <- make.unique(temp$V1)
    temp = temp[, colnames(temp) != "V1"]
    
    colnames(temp) = paste(colnames(temp), key, sep = "_")
    
    if(is.null(data)) {
        data = temp
    } else {
        data = cbind(data, temp[rownames(data), ])
    }
}

mcsaveRDS(data, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_psi.rds")
```


```{r}
fs = list.files("/mnt/raid61/Per", pattern = "psi$", full.names = T)

data = NULL
for (f in fs) {
    key = str_replace_all(basename(f), ".quant", "")
    
    if (str_detect(key, "bak")) {
        next
    }
    
    print(key)
    temp = fread(f)
    temp = as.data.frame(temp)
    rownames(temp) <- make.unique(temp$V1)
    temp = temp[, colnames(temp) != "V1"]
    
    colnames(temp) = paste(colnames(temp), key, sep = "_")
    
    if(is.null(data)) {
        data = temp
    } else {
        data = cbind(data, temp[rownames(data), ])
    }
}
```


### 
```{r}
meta = read.xlsx("/mnt/raid64/ATS/Personal/zhangyiming/sample_info.xlsx")

temp = data.frame(
    Cells=colnames(data),
    Patient=sapply(colnames(data), function(x) { str_split(x, "_")[[1]][2] })
)

meta = merge(temp, meta, by.x = "Patient", by.y = "X3")
rownames(meta) <- meta$Cells

sc_meta = readRDS("/mnt/raid64/Covid19_Gravida/rds/meta_rm_doublets.rds")

meta$CellType = sc_meta[rownames(meta), "CellType"]
meta = meta[!is.na(meta$CellType), ]

saveRDS(meta, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/meta.rds")


library(dplyr)
gene = read.table("/mnt/raid64/ATS/Personal/zhangyiming/stats/overall_ATS_cage_R_gene")

temp = gene %>%
  group_by(V3) %>%
  add_tally() %>%
  as.data.frame()

data = data[paste(temp$V3, temp$V2, sep = "|"), ]

```


```{r}
data = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_counts.rds")
gene = read.table("/mnt/raid64/ATS/Personal/zhangyiming/stats/overall_ATS_cage_R_gene")

data = data[intersect(gene$V2, rownames(data)), ]

mcsaveRDS(data, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_counts.rds")

library(dplyr)
library(progress)
gene = read.table("/mnt/raid64/ATS/Personal/zhangyiming/stats/overall_ATS_cage_R_gene")

temp = gene %>%
  group_by(V3) %>%
  add_tally() %>%
  as.data.frame()

temp = temp[temp$n < 5 & temp$n > 1, ]

data <- trqwe::mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_counts.rds")
pb <- progress_bar$new(total = length(unique(gene$V3)))

data = data[temp$V2, ]

for (i in unique(gene$V3)) {
  pb$tick()
  ats = as.character(gene$V2[gene$V3 == i])
  data[ats, ] = data[ats, ] / colSums(data[ats, ])
}

rs = rowSums(data, na.rm = T)
cs = colSums(data, na.rm = T)


plot(density(rs))
plot(density(cs))
```


```{r}
# obj <- mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/seurat_obj.rds")

meta = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/meta.rds")

colnames(data) <- str_replace_all(colnames(data), ".psi", "")

obj <- CreateSeuratObject(
  data[, rownames(meta)], 
  meta.data = meta
)

mcsaveRDS(obj, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/seurat_obj_psi.rds")
```


```{r}
obj = NormalizeData(obj, normalization.method = "LogNormalize", scale.factor = 10000)
obj = FindVariableFeatures(obj, selection.method = "vst", nfeatures = 2000)
obj <- ScaleData(obj, rownames(obj))

mcsaveRDS(obj, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/seurat_obj_5000.rds")

Idents(obj) <-  "CellType"
markers = FindAllMarkers(obj, logfc.threshold = 0, test.use = "wilcox", group.by = "CellType")
```



```{r}
psi <- mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_psi.rds")
colnames(psi) <- str_replace_all(colnames(psi), ".psi", "")
meta = readRDS("/mnt/raid64/Covid19_Gravida/rds/meta_rm_doublets.rds")
meta = meta[!meta$CellType %in% c("HSC", "erythroid", "platelet"), ]

meta$recovery_stage = sapply(meta$recovery_stage, function(x) {
  id_maps = c(
    "HNC"="NHC", "RP_S1"="PCovM", "RP_S2"="PCovS",
    "HPC"="PHC", "RN_S1"="NCovM", "RN_S2"="NCovS"
    )
  
  id_maps[[x]]
})

mono <- trqwe::mcreadRDS("/mnt/raid64/Covid19_Gravida/rds/seurat_mono.rds")

cells = colnames(mono)[colnames(mono) %in% rownames(meta)]
meta[cells, "CellType"] = mono@meta.data[cells, "CellType"]

set.seed(42)
meta = meta[sample(1:nrow(meta), 50000, replace = F),]

meta$CellType = factor(meta$CellType)


gc()

# fake_counts = matrix(0, nrow = nrow(psi), ncol = ncol(psi))
# fake_counts = apply(fake_counts, 1, function(x) {
#   sample.int(10, size = ncol(psi), replace = T)
# })
# fake_counts = as.matrix(t(fake_counts))
# 
# rownames(fake_counts) = rownames(psi)
# colnames(fake_counts) = colnames(psi)
# mcsaveRDS(fake_counts, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/fake_psi_counts.rds")


fake_counts = mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/fake_psi_counts.rds")


cells = intersect(colnames(fake_counts), rownames(meta))

obj <- ICASDataSetFromMatrix(
  countData = as.matrix(fake_counts[, cells]),
  colData = meta[cells, ],
  design = "CellType"
)

ICAS::psi(obj) <- as.matrix(psi)

obj@design = "CellType"
markers1 = ICAS::FindAllMarkers(obj, deltapsi.threshold = 0, test.use = "tobit", group.by = "CellType")

saveRDS(markers1,"/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes_tobit_celltype.rds")

fake_counts = mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/fake_psi_counts.rds")

meta$recovery_stage = factor(meta$recovery_stage)
obj <- ICASDataSetFromMatrix(
  countData = fake_counts,
  colData = meta,
  design = "recovery_stage"
)

ICAS::psi(obj) <- as.matrix(psi)


markers = ICAS::FindAllMarkers(obj, logfc.threshold = 0, test.use = "tobit", group.by = "recovery_stage")

saveRDS(markers,"/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes_tobit_stage.rds")
```



## New plot
```{R fig.height=4, fig.width=12}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_psi.rds")


temp = markers[markers$cell %in% c("Inter. mono", "Non-class. mono", "Class. mono"), ]

temp = temp[temp$p_val_adj < 0.05 & abs(temp$deltaPSI) > 0.1, ]
temp$group = str_replace_all(temp$group, "-(N|P)HC", "")

temp = reshape2::dcast(
  temp, group~cell+gene, 
  value.var = "deltaPSI", 
  fill = 0, fun.aggregate = mean
)

rownames(temp) <- temp$group
temp = temp[, colnames(temp) != "group"]

genes = sapply(
  colnames(temp),
  function(x) {
    str_split(x, "[_\\|]")[[1]][2]
  }
)

genes = rep("grey75", length(genes))
names(genes) = sapply(
  colnames(temp),
  function(x) {
    str_split(x, "[_\\|]")[[1]][2]
  }
)

sel_genes = c()
for (i in c("^TNF", "^IL", "^CCR")) {
  sel_genes = unique(c(sel_genes, names(genes)[str_detect(names(genes), i)]))
}

colors1 = as.character(wesanderson::wes_palette("Zissou1", length(sel_genes), type = "continuous"))
names(colors1) <- sel_genes

for (i in c("^TNF", "^IL", "^CCR")) {
  for (j in names(genes)[str_detect(names(genes), i)]) {
    genes[[j]] <- colors1[[j]]
  }
}


ba = HeatmapAnnotation(
  group = colnames(temp),
  col = list(
    group = sapply(colnames(temp), function(x) { 
      x = str_split(x, "[_\\|]")[[1]][2]
      genes[[x]] 
    })
  ),
  show_legend = F,
  show_annotation_name = F
)


h <- Heatmap(
  temp[c("PCovM", "PCovS", "NCovM", "NCovS"), ],
  name = "deltaPSI",
  cluster_rows = F, cluster_columns = T,
  clustering_method_columns = "ward.D2",
  column_split = sapply(colnames(temp), function(x) {
    str_split(x, "_")[[1]][1]
  }),
  show_column_names = F,
  border = T,
  use_raster = T,
  bottom_annotation = ba
)

pdf("/mnt/data5/zhangyiming/biye/mono_psi.pdf", width = 12, height = 4)
draw(h)
dev.off()


colors1

lgd = Legend(
  labels = names(colors1), 
  title = "Gene", 
  legend_gp = gpar(fill = colors1)
)

lgd2 = Legend(
  col_fun = colorRamp2(c(-0.4, 0, 0.4), c("blue", "#EAEAEA", "red")), 
  title = "deltaPSI", 
  at = c(-0.4, -0.2, 0, 0.2, 0.4)
)

pdf("/mnt/data5/zhangyiming/biye/mono_psi_legend.pdf")
draw(packLegend(lgd, lgd2, direction = "horizontal"))
dev.off()

```



### lymphoid以及myeloid之间比例
```{R}
group = list(
  "lymphoid"=c("Treg", "MAIT", "naïve CD4", "Proliferative T", "γδT", "NKT", "CD8 memory", "naïve CD8", "CD8 CTL", "naïve B", "memory B", "NK", "pDC"),
  "myeloid"=c("mDC",  "Class. mono", "Non-class. mono", "Inter. mono")
)


meta = readRDS("/mnt/raid64/Covid19_Gravida/rds/meta_rm_doublets.rds")
meta = meta[!meta$CellType %in% c("HSC", "erythroid", "platelet"), ]

meta$recovery_stage = sapply(meta$recovery_stage, function(x) {
  id_maps = c(
    "HNC"="NHC", "RP_S1"="PCovM", "RP_S2"="PCovS",
    "HPC"="PHC", "RN_S1"="NCovM", "RN_S2"="NCovS"
    )

  id_maps[[x]]
})

mono <- trqwe::mcreadRDS("/mnt/raid64/Covid19_Gravida/rds/seurat_mono.rds")

cells = colnames(mono)[colnames(mono) %in% rownames(meta)]
meta[cells, "CellType"] = mono@meta.data[cells, "CellType"]

meta$CellType = factor(meta$CellType)

meta$Class = "None"
for(i in names(group)) {
  meta$Class[meta$CellType %in% group[[i]]] = i
}


psi <- mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_psi.rds")
colnames(psi) <- str_replace_all(colnames(psi), ".psi", "")
fake_counts = mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/fake_psi_counts.rds")

cells = intersect(colnames(psi), rownames(meta))

meta$ClassGroup = factor(paste(meta$Class, meta$recovery_stage))
meta$CellGroup = factor(paste(meta$CellType, meta$recovery_stage))


set.seed(42)
cells = sample(cells, round(length(cells) / 10))
fake_counts = fake_counts[, cells]
psi = psi[, cells]

gc()

obj <- ICASDataSetFromMatrix(
  countData = fake_counts[, cells],
  colData = meta[cells, ],
  design = "ClassGroup"
)

ICAS::psi(obj) <- as.matrix(psi)

obj@colData$CellGroup = factor(obj@colData$CellGroup)
obj@colData$ClassGroup = factor(obj@colData$ClassGroup)


markers1 = ICAS::FindAllMarkers(obj, delta.threshold = 0, test.use = "tobit", group.by = "CellType")



markers = NULL
obj@design = "ClassGroup"
for (i in c("lymphoid", "myeloid")) {
  print(i)

  for (j in c("NCovM", "NCovS")) {
      temp = ICAS::FindMarkers(
        obj, 
        ident.1 = paste(i, j),
        ident.2 = paste(i, "NHC"),
        delta.threshold = 0,
        test.use = "tobit"
      )
      
      if (nrow(temp) > 0) {
        temp$gene = rownames(temp)
        temp$group = paste(j, "NHC", sep = "-")
        temp$cell = i
        markers = rbind(markers, temp)
      }
  }
  
  for (j in c("PCovM", "PCovS")) {
      temp = ICAS::FindMarkers(
        obj, 
        ident.1 = paste(i, j),
        ident.2 = paste(i, "PHC"),
        delta.threshold = 0,
        test.use = "tobit"
      )
      
      if (nrow(temp) > 0) {
        temp$gene = rownames(temp)
        temp$group = paste(j, "PHC", sep = "-")
        temp$cell = i
        markers = rbind(markers, temp)
      }
  }
}


obj@design = "CellGroup"
for (i in unique(obj@colData$CellType)) {
  print(i)
  
  if (i %in% markers$cell) {
    next
  }

  for (j in c("NCovM", "NCovS")) {
      tryCatch({
        temp = ICAS::FindMarkers(
          obj, 
          ident.1 = paste(i, j),
          ident.2 = paste(i, "NHC"),
          delta.threshold = 0,
          test.use = "tobit"
        )
        
        if (nrow(temp) > 0) {
          temp$gene = rownames(temp)
          temp$group = paste(j, "NHC", sep = "-")
          temp$cell = i
          markers = rbind(markers, temp)
        }
      }, error = function(e) {})
  }
  
  for (j in c("PCovM", "PCovS")) {
      tryCatch({
        temp = ICAS::FindMarkers(
          obj, 
          ident.1 = paste(i, j),
          ident.2 = paste(i, "PHC"),
          delta.threshold = 0,
          test.use = "tobit"
        )
        
        if (nrow(temp) > 0) {
          temp$gene = rownames(temp)
          temp$group = paste(j, "PHC", sep = "-")
          temp$cell = i
          markers = rbind(markers, temp)
        }
      }, error = function(e) {})
  }
}


saveRDS(markers, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_psi.rds")
```


## CellType comparision
### CD14 mono and CD16 mono
```{r}
cells = sort(meta$CellType)


obj@design = "CellType"

i = "CD14 mono"
j = "CD16 mono"
tryCatch({
  temp = ICAS::FindMarkers(obj, ident.1 = i, ident.2 = j, test.use = "tobit", group.by = "CellType")
  
  if (nrow(temp) > 0) {
    temp$comp = paste(i, j, sep = " - ")
    markers = rbind(markers, temp)
  }
}, error = function(e) {
  print(e)
})

i = "NK"
j = "NKT"
tryCatch({
  temp = ICAS::FindMarkers(obj, ident.1 = i, ident.2 = j, test.use = "tobit", group.by = "CellType")
  
  if (nrow(temp) > 0) {
    temp$comp = paste(i, j, sep = " - ")
    markers = rbind(markers, temp)
  }
}, error = function(e) {})


i = "naïve CD4"
j = "naïve CD8"
tryCatch({
  temp = ICAS::FindMarkers(obj, ident.1 = i, ident.2 = j, test.use = "tobit", group.by = "CellType")
  
  if (nrow(temp) > 0) {
    temp$comp = paste(i, j, sep = " - ")
    markers = rbind(markers, temp)
  }
}, error = function(e) {
  print(e)
})


group = list(
  "lymphoid"=c("Treg", "MAIT", "naïve CD4", "Proliferative T", "γδT", "NKT", "CD8 memory", "naïve CD8", "CD8 CTL", "naïve B", "memory B", "NK", "pDC"),
  "myeloid"=c("mDC",  "CD16 mono", "CD14 mono")
)

obj@colData$Class = "None"
obj@colData$Class[obj@colData$CellType %in% group[["myeloid"]]] = "myeloid"
obj@colData$Class[obj@colData$CellType %in% group[["lymphoid"]]] = "lymphoid"
obj@colData$Class = factor(obj@colData$Class)

obj@design = "Class"

i = "myeloid"
j = "lymphoid"
tryCatch({
  temp = ICAS::FindMarkers(
    obj, 
    ident.1 = i, 
    ident.2 = j, 
    test.use = "tobit", group.by = "Class"
  )
  
  if (nrow(temp) > 0) {
    temp$comp = paste(i, j, sep = " - ")
    markers = rbind(markers, temp)
  }
}, error = function(e) {
  print(e)
})

markers$gene = str_replace_all(rownames(markers), "\\d+$", "")

saveRDS(obj, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/ICAS_obj.rds")
saveRDS(markers, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_lymphoid_myeloid.rds")
```


```{R}
markers = markers[order(markers$deltaPSI), ]

pct_thred = .3

set.seed(42)
pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/cell_types_and_class.pdf", width = 6, height = 6)
for (i in unique(markers$comp)) {
  cells = str_split(i, " - ")[[1]]
  
  if (!cells[1] %in% unique(obj@colData$CellType)) {
    temp_meta = obj@colData[obj@colData$Class %in% cells, ]
    
    temp_meta = as.data.frame(temp_meta) %>%
      group_by(Class) %>%
      sample_n(500, replace = T) %>%
      unique() %>%
      as.data.frame()
    
    temp = obj@psi[markers$gene[markers$comp == i & abs(markers$pct.2 - markers$pct.1) > pct_thred], as.character(temp_meta$Cells)]
    
    h = Heatmap(
      temp, name = "PSI",
      cluster_rows = F,
      cluster_columns = T,
      show_row_names = F,
      show_column_names = F,
      column_split = temp_meta$Class,
      clustering_method_rows = "ward.D2",
      col = colorRamp2(c(0, .5, 1), c("blue", "#EEEEEE", "red"), space = "RGB"),
      use_raster = T
    )
    
    draw(h)
  } else {
    temp_meta = obj@colData[obj@colData$CellType %in% cells, ]
    
    temp_meta = as.data.frame(temp_meta) %>%
      group_by(CellType) %>%
      sample_n(500, replace = T) %>%
      unique() %>%
      as.data.frame()
    
    temp = obj@psi[markers$gene[markers$comp == i & abs(markers$pct.2 - markers$pct.1) > pct_thred], as.character(temp_meta$Cells)]
    
    h = Heatmap(
      temp, name = "PSI",
      cluster_rows = F,
      cluster_columns = T,
      show_row_names = F,
      show_column_names = F,
      column_split = temp_meta$CellType,
      clustering_method_rows = "ward.D2",
      col = colorRamp2(c(0, .5, 1), c("blue", "#EEEEEE", "red"), space = "RGB"),
      use_raster = T
    )
    
    draw(h)
  }
}
dev.off()
```


```{R}
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes.rds")
markers <- markers[markers$p_val_adj < 0.05 & markers$avg_logFC > .5, ]

obj = RunPCA(obj, features = unique(markers$gene)) # VariableFeatures(object = obj))

ElbowPlot(obj)
```

```{R}
obj <- FindNeighbors(obj, dims = 1:6)
# obj <- FindClusters(obj, resolution = 0.5)
obj <- RunUMAP(obj, dims = 1:6)
```


```{r fig.height=6, fig.width=6}
DimPlot(obj, reduction = "umap", group.by = "CellType", label = T) +
    theme(legend.position = "none")
```


```{r}
# obj <- mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/seurat_obj_5000.rds")

meta = readRDS("/mnt/raid64/Covid19_Gravida/rds/meta_rm_doublets.rds")
obj@colData$recovery_stage = sapply(meta[rownames(obj@colData), "recovery_stage"], function(x) {
  id_maps = c(
    "HNC"="NHC", "RP_S1"="PCovM", "RP_S2"="PCovS",
    "HPC"="PHC", "RN_S1"="NCovM", "RN_S2"="NCovS"
    )
  
  id_maps[[x]]
})
```


```{r}
custom_fill_colors = c(
    RColorBrewer::brewer.pal(9, "Blues")[c(4, 6, 8, 9)],
    RColorBrewer::brewer.pal(9, "Greens")[4:7],
    RColorBrewer::brewer.pal(9, "YlGn")[1],
    RColorBrewer::brewer.pal(9, "Oranges")[c(2, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Reds")[c(1, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Purples")[4:6],
    "grey75"
)
names(custom_fill_colors) <- c(
    "Class. mono", "Non-class. mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "platelet", "erythroid",
    "Inter. mono"
)


# names(custom_fill_colors) <- sort(unique(obj@meta.data$CellType))
umap = as.data.frame(obj@reductions$umap@cell.embeddings)
umap$X2 = obj@meta.data[rownames(umap), "CellType"]
umap$group = as.character(obj@meta.data[rownames(umap), "recovery_stage"])
umap = umap[!umap$X2 %in% c("HSC", "platelet", "erythroid"), ]

pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/cell_types.pdf", width  = 6, height = 6)
make_cell_types_plot3(
    umap,  
    group_by = "X2", 
    label = "X2",
    title = "",
    legend.position = "none",
    text_size = 5,
    colors = custom_fill_colors
)
dev.off()
# DimPlot(obj, reduction = "umap", label = T) + NoLegend()



colors = c(
  RColorBrewer::brewer.pal(9, "RdYlGn")[c(1, 3)],
  RColorBrewer::brewer.pal(9, "Blues")[5],
  RColorBrewer::brewer.pal(9, "Greens")[5],
  RColorBrewer::brewer.pal(9, "Blues")[7],
  RColorBrewer::brewer.pal(9, "Greens")[7]
)
names(colors) = c("PCovS", "NCovS", "PCovM", "NCovM", "PHC", "NHC")

make_cell_types_plot3(
    umap,  
    group_by = "group", 
    label = "group",
    title = "",
    legend.position = "none",
    text_size = 5,
    colors = colors
)
```



```{r}
registerDoMC(10)
markers = foreach (i = unique(obj@meta.data$CellType), .combine = "rbind") %dopar% {
    temp = FindMarkers(obj, ident.1 = i, group.by = "CellType")
    temp$gene = rownames(temp)
    temp$CellType = i
    temp
}


saveRDS(markers, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes.rds")
```



```{r}
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes.rds")
markers <- markers[markers$p_val_adj < 0.05, ]
markers <- markers[!markers$CellType %in% c("platelet", "erythroid", "HSC"), ]
```


```{r fig.height=6, fig.width=10}
temp = dcast(markers, gene~CellType, value.var = "avg_logFC", fill = 0)
rownames(temp) <- temp$gene
temp = temp[, colnames(temp) != "gene"]

Heatmap(
  t(temp), name = "avg_logFC",
  col = colorRamp2(c(-3, 0, 3), c("blue", "grey75", "red")),
  show_column_names = F,
  clustering_method_rows = "ward.D2",
  clustering_method_columns = "ward.D2"
)
```


## Prepare cell type specific bc list
```{r}
# temp = obj@colData[!obj@colData$CellType %in% c("platelet", "erythroid", "HSC"), ]

colData <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/colData.rds")


temp = colData[!colData$CellType %in% c("platelet", "erythroid", "HSC"), ]

# mono <- trqwe::mcreadRDS("/mnt/raid64/Covid19_Gravida/rds/seurat_mono.rds")
# 
# temp = meta[!meta$CellType %in% c("platelet", "erythroid", "HSC"), ]

temp$group = str_replace_all(temp$recovery_stage, "(S|M)$", "")

# map_ids = list()
# for (i in 1:nrow(temp)) {
#   map_ids[[as.character(temp[i, "Patient"])]] = temp[i, "recovery_stage"]
# }


temp$FCells =  sapply(temp$Cell, function(x) {
   x = str_split(x, "_")[[1]]
   paste(x[2], x[1], sep = "_")
})


# temp$FCells = sapply(temp$Cells, function(x) {
#   x = str_split(x, "_")[[1]]
#   paste(map_ids[[x[2]]], x[1], sep = "_")
# })


write.table(
  temp[, c("FCells", "CellType")], "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/celltype_bc.txt", 
  quote = F, col.names = F, row.names = F, sep = "\t"
)


write.table(
  temp[temp$CellType %in% c("Class. mono", "Non-class. mono", "Inter. mono"), c("FCells", "CellType")], "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/mono_bc.txt", 
  quote = F, col.names = F, row.names = F, sep = "\t"
)

write.table(
  data.frame(
    cell = c("Class. mono", "Non-class. mono", "Inter. mono"), 
    color = c(
      RColorBrewer::brewer.pal(11, "RdYlBu")[3], 
      RColorBrewer::brewer.pal(11, "RdYlBu")[6], 
      RColorBrewer::brewer.pal(11, "RdYlBu")[9]
      )
  ), "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/mono_order.txt", 
  quote = F, col.names = F, row.names = T, sep = "\t"
)


group = list(
  "lymphoid"=c("Treg", "MAIT", "naïve CD4", "Proliferative T", "γδT", "NKT", "CD8 memory", "naïve CD8", "CD8 CTL", "naïve B", "memory B", "NK", "pDC"),
  "myeloid"=c("mDC",  "CD16 mono", "CD14 mono")
)

temp$Class = "None"
for(i in names(group)) {
  temp$Class[temp$CellType %in% group[[i]]] = i
}

set.seed(42)
temp_meta = as.data.frame(temp) %>%
  group_by(Class) %>%
  sample_n(500, replace = T) %>%
  unique() %>%
  as.data.frame()

# temp_meta$group = str_replace_all(temp_meta$recovery_stage, "(S|M)$", "")

# temp_meta$FCells = sapply(temp_meta$Cells, function(x) {
#   x = str_split(x, "_")[[1]]
#   paste(map_ids[[x[2]]], x[1], sep = "_")
# })


write.table(
  temp[temp$Class != "None", c("FCells", "Class")], "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/cellclass_bc.txt", 
  quote = F, col.names = F, row.names = F, sep = "\t"
)



custom_fill_colors = c(
    RColorBrewer::brewer.pal(9, "Blues")[c(4, 6, 8, 9)],
    RColorBrewer::brewer.pal(9, "Greens")[4:7],
    RColorBrewer::brewer.pal(9, "YlGn")[1],
    RColorBrewer::brewer.pal(9, "Oranges")[c(2, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Reds")[c(1, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Purples")[4:6],
    "grey75"
)
names(custom_fill_colors) <- c(
    "CD14 mono", "CD16 mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "platelet", "erythroid",
    "NA"
)

temp = as.data.frame(custom_fill_colors)
temp = temp[!rownames(temp) %in% c("NA", "platelet", "erythroid", "HSC"), , drop = F]

write.table(
  temp, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/celltype_order.txt", 
  quote = F, col.names = F, row.names = T, sep = "\t"
)


write.table(
  data.frame(
    cell = c("lympoid", "myeloid"), 
    color = c(RColorBrewer::brewer.pal(11, "RdYlBu")[3], RColorBrewer::brewer.pal(11, "RdYlBu")[9])
  ), "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/cellclass_order.txt", 
  quote = F, col.names = F, row.names = T, sep = "\t"
)
```



```{r}
meta = readRDS("/mnt/raid64/Covid19_Gravida/rds/meta_rm_doublets.rds")
obj@meta.data$recovery_stage = sapply(meta[rownames(obj@meta.data), "recovery_stage"], function(x) {
  id_maps = c(
    "HNC"="NHC", "RP_S1"="PCovM", "RP_S2"="PCovS",
    "HPC"="PHC", "RN_S1"="NCovM", "RN_S2"="NCovS"
    )
  
  id_maps[[x]]
})


obj@colData$temp_group = paste(obj@colData$CellType, obj@colData$recovery_stage, sep = "|")


calculate_markers <- function(obj, ident.1, ident.2, group.by, comp) {
  tryCatch({
    temp = FindMarkers(
      obj, ident.1 = paste(i, j, sep = "|"), 
      ident.2 = paste(i, "NHC", sep = "|"), 
      group.by = "temp_group",
      logfc.threshold = 0
    )
    temp$gene = rownames(temp)
    temp$CellType = i
    temp$comp = paste(j, "HN", sep = " - ")
    return(temp)
  }, error = function(e) {})
  
  return(NULL)
}


ref = readRDS("/mnt/raid64/Covid19_Gravida/rds/meta_rm_doublets.rds")
meta$recovery_stage = sapply(ref[rownames(meta), "recovery_stage"], function(x) {
  id_maps = c(
    "HNC"="NHC", "RP_S1"="PCovM", "RP_S2"="PCovS",
    "HPC"="PHC", "RN_S1"="NCovM", "RN_S2"="NCovS"
    )
  
  id_maps[[x]]
})

markers = NULL
for (i in unique(meta$CellType)) {
  temp_meta = meta[meta$CellType == i, ]
  temp_meta$recovery_stage = factor(temp_meta$recovery_stage)
  obj <- ICASDataSetFromMatrix(
    countData = fake_counts[, rownames(temp_meta)],
    colData = temp_meta,
    design = "recovery_stage"
  )
  
  ICAS::psi(obj) <- as.matrix(psi[, rownames(temp_meta)])
  
    if (i %in% c("HSC", "erythroid", "platelet" )) {
      next
    }
  
    print(i)

    for (j in c("NCovM", "NCovS")) {
        temp = ICAS::FindMarkers(
          obj, ident.1 = j, 
          ident.2 = "NHC", 
          group.by = "temp_group",
          logfc.threshold = 0,
          test.use = "tobit"
        )
        temp$gene = rownames(temp)
        temp$CellType = i
        temp$comp = paste(j, "NHC", sep = " - ")
        markers = rbind(markers, temp)
    }
    
    for (j in c("PCovM", "PCovS")) {
        temp = ICAS::FindMarkers(
          obj, ident.1 = j, 
          ident.2 = "PHC", 
          group.by = "temp_group",
          logfc.threshold = 0,
          test.use = "tobit"
        )
        temp$gene = rownames(temp)
        temp$CellType = i
        temp$comp = paste(j, "PHC", sep = " - ")
        markers = rbind(markers, temp)
        
        temp = ICAS::FindMarkers(
          obj, ident.1 = j, 
          ident.2 = str_replace_all(j, "P", "N"), 
          group.by = "temp_group",
          logfc.threshold = 0,
          test.use = "tobit", 
        )
        temp$gene = rownames(temp)
        temp$CellType = i
        temp$comp = paste(j, str_replace_all(j, "P", "N"), sep = " - ")
        markers = rbind(markers, temp)
    }
    
    temp = ICAS::FindMarkers(
      obj, ident.1 = "NCovS", 
      ident.2 = "NCovM", 
      group.by = "temp_group",
      logfc.threshold = 0
    )
    temp$gene = rownames(temp)
    temp$CellType = i
    temp$comp = "NCovS - NCovM"
    markers = rbind(markers, temp)
    
    temp = ICAS::FindMarkers(
      obj, ident.1 = "PCovS",
      ident.2 = "PCovM", 
      group.by = "temp_group",
      logfc.threshold = 0,
      test.use = "tobit"
    )
    temp$gene = rownames(temp)
    temp$CellType = i
    temp$comp = "PCovS - PCovM"
    markers = rbind(markers, temp)
}
```


```{R}
markers = markers[markers$p_val_adj < 0.05, ]
temp = markers %>%
  group_by(CellType, comp) %>%
  add_tally() %>%
  dplyr::select(CellType, comp,n) %>%
  unique() %>%
  as.data.frame()


temp = obj@meta.data[!obj@meta.data$CellType %in% c("platelet", "erythroid", "HSC"), ]


meta$recovery_stage = sapply(meta[, "recovery_stage"], function(x) {
  id_maps = c(
    "HNC"="NHC", "RP_S1"="PCovM", "RP_S2"="PCovS",
    "HPC"="PHC", "RN_S1"="NCovM", "RN_S2"="NCovS"
    )
  
  id_maps[[x]]
})


temp = meta[!meta$CellType %in% c("platelet", "erythroid", "HSC"), ]
temp$recovery_stage = as.character(meta[as.character(temp$Cell), "recovery_stage"])
temp$group = str_replace_all(temp$recovery_stage, "(S|M)$", "")

# map_ids = list()
# for (i in 1:nrow(temp)) {
#   map_ids[[as.character(temp[i, "Patient"])]] = temp[i, "recovery_stage"]
# }

temp$FCells =  sapply(temp$Cell, function(x) {
   x = str_split(x, "_")[[1]]
   paste(x[2], x[1], sep = "_")
})

for (i in unique(temp$CellType)) {
  # temp$FCells = sapply(temp$Cells, function(x) {
  #   x = str_split(x, "_")[[1]]
  #   paste(map_ids[[x[2]]], x[1], sep = "_")
  # })
  
  write.table(
    temp[temp$CellType == i, c("FCells", "recovery_stage")], 
    paste0("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/celltype_bc/", str_replace_all(i, " ", "_"), "_bc.txt"), 
    quote = F, col.names = F, row.names = F, sep = "\t"
  )
}


group = list(
  "lymphoid"=c("Treg", "MAIT", "naïve CD4", "Proliferative T", "γδT", "NKT", "CD8 memory", "naïve CD8", "CD8 CTL", "naïve B", "memory B", "NK", "pDC"),
  "myeloid"=c("mDC",  "CD16 mono", "CD14 mono")
)

temp$Class = "None"
for(i in names(group)) {
  temp$Class[temp$CellType %in% group[[i]]] = i
}

for (i in names(group)) {
  # temp$FCells = sapply(temp$Cells, function(x) {
  #   x = str_split(x, "_")[[1]]
  #   paste(map_ids[[x[2]]], x[1], sep = "_")
  # })
  
  write.table(
    temp[temp$Class == i, c("FCells", "recovery_stage")], 
    paste0("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/celltype_bc/", str_replace_all(i, " ", "_"), "_bc.txt"), 
    quote = F, col.names = F, row.names = F, sep = "\t"
  )
}



temp$FCells = as.character(rownames(temp))
write.table(
    temp[, c("FCells", "recovery_stage")], 
    "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/stage_bc.txt", 
    quote = F, col.names = F, row.names = F, sep = "\t"
)

colors = c(
  RColorBrewer::brewer.pal(9, "RdYlGn")[c(1, 3)],
  RColorBrewer::brewer.pal(9, "Blues")[5],
  RColorBrewer::brewer.pal(9, "Greens")[5],
  RColorBrewer::brewer.pal(9, "Blues")[7],
  RColorBrewer::brewer.pal(9, "Greens")[7]
)
names(colors) = c("PCovS", "NCovS", "PCovM", "NCovM", "PHC", "NHC")

temp = as.data.frame(colors)

write.table(
  temp[c("PHC", "PCovM", "PCovS", "NHC", "NCovM", "NCovS"), , drop = F], "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/sashimi/cd14_mono_order.txt", 
  quote = F, col.names = F, row.names = T, sep = "\t"
)

```


```{r}
library(tsidx)

meta = obj@meta.data

meta$CellType <- as.factor(meta$CellType)

tsi <- tsDataSetFromMatrix(
    data[rowSums(data) > 2000, rownames(meta)], 
    meta, 
    ~ CellType, 
    type = "expression",
    convMethod = "log2",
    IbMethod = "mingap",
    mindiff = 3, 
    tidy = FALSE, 
    breaks = NULL,
)
gc()
```

```{r}
mcsaveRDS(tsi, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/tsi_2000.rds")

tau = as.data.frame(tsi@tsData$Tau)


saveRDS(tau, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/tau_2000.rds")
```


```{r}
counts = trqwe::mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/seurat_obj_5000.rds")
psi = trqwe::mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_psi.rds")

colnames(psi) = str_replace_all(colnames(psi), ".psi", "")
```



## CellType tobit hist
```{r}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes_tobit.rds")

hist(markers$p_val)
```


```{R fig.height=6, fig.width=10}
set.seed(42)
temp_meta = meta %>%
  group_by(CellType) %>%
  sample_n(500, replace = T) %>%
  unique() %>%
  as.data.frame()

custom_fill_colors = c(
    RColorBrewer::brewer.pal(9, "Blues")[c(4, 6, 8, 9)],
    RColorBrewer::brewer.pal(9, "Greens")[4:7],
    RColorBrewer::brewer.pal(9, "YlGn")[1],
    RColorBrewer::brewer.pal(9, "Oranges")[c(2, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Reds")[c(1, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Purples")[4:6],
    "grey75"
)
names(custom_fill_colors) <- c(
    "CD14 mono", "CD16 mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "platelet", "erythroid",
    "NA"
)

ta = HeatmapAnnotation(
  CellType = temp_meta$CellType,
  col = list(
    CellType = custom_fill_colors
  )
)


Heatmap(
  psi[markers$gene[markers$pct.1 > 0.5 & markers$pct.2 < .5], as.character(temp_meta$Cells)], name = "PSI",
  cluster_rows = F,
  cluster_columns = F,
  row_split = markers$CellType[markers$pct.1 > 0.5 & markers$pct.2 < .5],
  column_split = temp_meta$CellType,
  col = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red")),
  show_row_names = F, show_column_names = F,
  row_title_rot = 0,
  column_title_gp = gpar(fontsize = 0),
  top_annotation = ta
)
```


## group p val hist
```{r}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_groups_tobit.rds")

hist(markers$p_val)
```


## cell type p val hist
```{r}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes_psi.rds")

hist(markers$p_val)
```


```{R fig.height=6, fig.width=10}
set.seed(42)
temp_meta = meta %>%
  group_by(CellType) %>%
  sample_n(500, replace = T) %>%
  unique() %>%
  as.data.frame()

custom_fill_colors = c(
    RColorBrewer::brewer.pal(9, "Blues")[c(4, 6, 8, 9)],
    RColorBrewer::brewer.pal(9, "Greens")[4:7],
    RColorBrewer::brewer.pal(9, "YlGn")[1],
    RColorBrewer::brewer.pal(9, "Oranges")[c(2, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Reds")[c(1, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Purples")[4:6],
    "grey75"
)
names(custom_fill_colors) <- c(
    "CD14 mono", "CD16 mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "platelet", "erythroid",
    "NA"
)

ta = HeatmapAnnotation(
  CellType = temp_meta$CellType,
  col = list(
    CellType = custom_fill_colors
  )
)


Heatmap(
  psi[
    sapply(markers$gene[markers$pct.1 > 0.5 & markers$pct.2 < .5], function(x) {
      x = str_split(x, ":")[[1]]
      chrom = str_split(x, "-")[[1]]
      gene = paste(chrom[1:(length(chrom) - 1)], collapse = "-")
      
      chrom = chrom[length(chrom)]
      
      paste(gene, paste(c(chrom, x[2], x[3]), collapse = ":"), sep = "|")
    }), 
    as.character(temp_meta$Cells)
  ], name = "PSI",
  cluster_rows = F,
  cluster_columns = F,
  row_split = markers$CellType[markers$pct.1 > 0.5 & markers$pct.2 < .5],
  column_split = temp_meta$CellType,
  col = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red")),
  show_row_names = F, show_column_names = F,
  row_title_rot = 0,
  column_title_gp = gpar(fontsize = 0),
  top_annotation = ta
)
```

## group p val hist
```{r}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_groups_psi.rds")

hist(markers$p_val)
```


## group p val hist
```{r}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_groups_tobit.rds")

ggplot(markers, aes(x=p_val_adj, fill = CellType)) +
  geom_histogram(position = position_dodge())
```


```{R fig.height=6, fig.width=10}
temp_markers = markers[str_detect(markers$comp, "HC$") & markers$p_val_adj < 0.05,  ]


colors = c(
  RColorBrewer::brewer.pal(9, "RdYlGn")[c(1, 3)],
  RColorBrewer::brewer.pal(9, "Blues")[5],
  RColorBrewer::brewer.pal(9, "Greens")[5],
  RColorBrewer::brewer.pal(9, "Blues")[7],
  RColorBrewer::brewer.pal(9, "Greens")[7]
)
names(colors) = c("PCovS", "NCovS", "PCovM", "NCovM", "PHC", "NHC")


pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_groups_tobit.pdf", width = 10, height = 6)
for (i in unique(markers$CellType)) {
  set.seed(42)
  temp_meta = meta[meta$CellType == i, ] %>%
    group_by(recovery_stage) %>%
    sample_n(1500, replace = T) %>%
    unique() %>%
    as.data.frame()
  
  ta = HeatmapAnnotation(
    Group = temp_meta$recovery_stage,
    col = list(
      Group = colors
    )
  )
  
  h <- Heatmap(
    psi[
      temp_markers$gene[temp_markers$CellType == i], 
      as.character(temp_meta$Cells)
    ], name = "PSI",
    cluster_rows = T,
    cluster_columns = T,
    row_split = temp_markers$comp[temp_markers$CellType == i],
    column_split = temp_meta$recovery_stage,
    col = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red")),
    show_row_names = F, show_column_names = F,
    row_title_rot = 0,
    # column_title_gp = gpar(fontsize = 0),
    column_title = i,
    use_raster = T,
    top_annotation = ta
  )
  draw(h)
}
dev.off()
```


### UMAP
```{r}
obj <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/ICAS_obj.rds")

so = CreateSeuratObject(
  round(obj@psi),
  meta.data = as.data.frame(obj@colData)
)

so = NormalizeData(so)
so@assays$RNA@data = obj@psi
rownames(so@assays$RNA@data) = rownames(so@assays$RNA@counts)
so = FindVariableFeatures(so)
so = ScaleData(so)
so@assays$RNA@scale.data = obj@psi
rownames(so@assays$RNA@scale.data) = rownames(so@assays$RNA@counts)
so = RunPCA(so)
```

```{R}
ElbowPlot(so)
```


```{r}
so = RunUMAP(so, dims = 1:5)
```


```{R}
DimPlot(so, reduction = "umap", group.by = "CellType")
```

```{r}

make_cell_types_plot3 <- function(
    coord,
    pt.size = 0.1, 
    alpha = 0.8,
    text_size = 10,
    axis_size = 18,
    axis_title_size = 20,
    title_size = 25,
    group_by = "",
    label = "cell_name",
    title = "Cell type",
    legend.position = "none",
    colors = NULL
) {
    data = coord[, c("UMAP_1", "UMAP_2", group_by, label)]
    colnames(data) = c("UMAP1", "UMAP2", group_by, "Label")
    label = "Label"
    
    if (group_by == "") {
        group_by = "cell"
    }
    
    p <- eval(
        parse(text=paste0(
                "ggplot(data = data, aes(x=UMAP1, y=UMAP2, color=", group_by, ", alpha=alpha))"
            )
        )
    )
    
    if (!is.null(label)) {

        text_loc = eval(
            parse(text=paste0("data %>% group_by(", label, ") %>% mutate(x = median(UMAP1), y = median(UMAP2)) %>% dplyr::select(x, y, ", label, ")"))
        )
        
        text_loc = text_loc %>% unique() %>% as.data.frame()
        
        # print(text_loc)
    }
    
    p <- p + geom_point_rast(aes(alpha=alpha), size = pt.size)
    
    if (!is.null(label)) {
        p <- p + eval(parse(text=paste0("geom_text_repel(data = text_loc,  aes(x=x, y=y, label = ", label, "), color = \"black\", size = text_size, alpha = 1)")))
    }
    
    p <- p + 
        theme_bw() +
        labs(
            title = title
        ) +
        theme(
            plot.title = element_text(hjust = 0.5, face="bold", size = title_size),
            legend.position = legend.position,
            axis.text = element_text(size = axis_size),
            axis.title = element_text(size = axis_title_size),
            panel.grid = element_blank(),
            aspect.ratio=1
        )
    
    if (!is.null(colors)) {
        p <- p + scale_color_manual(values = colors)
    }
    p
}


custom_fill_colors = c(
    RColorBrewer::brewer.pal(9, "Blues")[c(4, 6, 8, 9)],
    RColorBrewer::brewer.pal(9, "Greens")[4:7],
    RColorBrewer::brewer.pal(9, "YlGn")[1],
    RColorBrewer::brewer.pal(9, "Oranges")[c(2, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Reds")[c(1, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Purples")[4:6],
    "grey75"
)
names(custom_fill_colors) <- c(
    "CD14 mono", "CD16 mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "platelet", "erythroid",
    "NA"
)

colors = c(
  RColorBrewer::brewer.pal(9, "RdYlGn")[c(1, 3)],
  RColorBrewer::brewer.pal(9, "Blues")[5],
  RColorBrewer::brewer.pal(9, "Greens")[5],
  RColorBrewer::brewer.pal(9, "Blues")[7],
  RColorBrewer::brewer.pal(9, "Greens")[7]
)
names(colors) = c("PCovS", "NCovS", "PCovM", "NCovM", "PHC", "NHC")

colors1 = c(
  RColorBrewer::brewer.pal(9, "RdYlGn")[1],
  RColorBrewer::brewer.pal(9, "RdYlGn")[3],
  RColorBrewer::brewer.pal(9, "Blues")[7],
  RColorBrewer::brewer.pal(9, "Greens")[7]
)
names(colors1) = c("PCov", "NCov", "PHC", "NHC")
```


```{r}
so@meta.data$recovery_stage = sapply(meta[rownames(so@meta.data), "recovery_stage"], function(x) {
  id_maps = c(
    "HNC"="NHC", "RP_S1"="PCovM", "RP_S2"="PCovS",
    "HPC"="PHC", "RN_S1"="NCovM", "RN_S2"="NCovS"
    )
  
  id_maps[[x]]
})


# names(custom_fill_colors) <- sort(unique(obj@meta.data$CellType))
umap = as.data.frame(so@reductions$umap@cell.embeddings)
umap$X2 = so@meta.data[rownames(umap), "CellType"]
umap$group = as.character(so@meta.data[rownames(umap), "recovery_stage"])
umap = umap[!umap$X2 %in% c("HSC", "platelet", "erythroid"), ]

pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/celltype_umap.pdf", width  = 6, height = 6)
make_cell_types_plot3(
    umap,  
    group_by = "X2", 
    label = "X2",
    title = "",
    legend.position = "none",
    text_size = 5,
    colors = custom_fill_colors
)
dev.off()
# DimPlot(obj, reduction = "umap", label = T) + NoLegend()


umap$X3 = umap$X2

# plist = list()
# for(i in c("PHC", "PCov", "NHC",  "NCov")) {
#   umap$X2 = umap$X3
#   umap$X2[!str_detect(umap$group, i)] = "NA"
#   umap = rbind(umap[umap$X2 == "NA", ], umap[umap$X2 != "NA", ])
#   plist[[length(plist) + 1]] <- make_cell_types_plot3(
#       umap,  
#       group_by = "X2", 
#       label = "X2",
#       title = str_replace_all(str_replace_all(i, "HNC", "NHC"), "HPC", "PNC"),
#       legend.position = "none",
#       text_size = 5,
#       colors = custom_fill_colors
#   ) + theme(axis.ticks = element_blank(), axis.text = element_blank()) + labs(x="", y="")
# }


plist = list()
for(i in c("P", "N")) {
  umap$X2 = umap$X3
  umap$X2 = str_replace_all(umap$group, "(S|M)$", "")
  umap$X2[!str_detect(umap$group, i)] = "NA"
  umap = rbind(umap[umap$X2 == "NA", ], umap[umap$X2 != "NA", ])
  plist[[length(plist) + 1]] <- make_cell_types_plot3(
      umap,  
      group_by = "X2", 
      label = "X2",
      title = str_replace_all(str_replace_all(i, "HNC", "NHC"), "HPC", "PNC"),
      legend.position = "none",
      text_size = 5,
      colors = c("NA" = "grey75", colors1)
  ) + theme(axis.ticks = element_blank(), axis.text = element_blank()) + labs(x="", y="")
}


pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/celltype_umap_P_N.pdf", width  = 12, height = 12)
cowplot::plot_grid(plotlist = plist, ncol = 2)
dev.off()

mcsaveRDS(so, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/seurat_obj_psi.rds")
```


## Cell type specific markers
```{r}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes_tobit.rds")

temp = dcast(as.data.frame(markers), gene~CellType, value.var = "deltaPSI", fun.aggregate = mean, fill = 0)
rownames(temp) <- temp$gene
temp  = temp[, colnames(temp) != "gene"]


Heatmap(
  temp, name = "deltaPSI", 
  col = colorRamp2(c(min(markers$deltaPSI), 0, max(markers$deltaPSI)), c("blue", "grey75", "red")),
  show_row_names = F
)
```


```{r}
markers = readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_lymphoid_myeloid.rds")

temp = dcast(as.data.frame(markers), gene~comp, value.var = "deltaPSI", fun.aggregate = mean, fill = 0)
rownames(temp) <- temp$gene
temp  = temp[, colnames(temp) != "gene"]


Heatmap(
  temp, name = "deltaPSI", 
  col = colorRamp2(c(min(markers$deltaPSI), 0, max(markers$deltaPSI)), c("blue", "grey75", "red")),
  show_row_names = F
)
```

## GO
```{R fig.height=5, fig.width=8}
library(clusterProfiler)
library(org.Hs.eg.db)


go = enrichGO(
  sapply(markers$gene[markers$comp == "myeloid - lymphoid" & markers$p_val_adj < 0.05], function(x) {
    str_split(x, "\\|")[[1]][1]
  }),
  OrgDb = org.Hs.eg.db,
  keyType = "SYMBOL",
  ont = "BP"
)

p <- dotplot(go)

ggsave(
  filename = "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/myleoid_lymphoid_go.pdf",
  height = 5, width = 8
)

```


```{r}
go = enrichGO(
  sapply(markers$gene[markers$comp == "CD14 mono - CD16 mono" & markers$p_val_adj < 0.05], function(x) {
    str_split(x, "\\|")[[1]][1]
  }),
  OrgDb = org.Hs.eg.db,
  keyType = "SYMBOL",
  ont = "BP"
)

dotplot(go)
```



## 

```{R}
colors = c(
  RColorBrewer::brewer.pal(9, "RdYlGn")[c(1, 3)],
  RColorBrewer::brewer.pal(9, "Blues")[5],
  RColorBrewer::brewer.pal(9, "Greens")[5],
  RColorBrewer::brewer.pal(9, "Blues")[7],
  RColorBrewer::brewer.pal(9, "Greens")[7]
)
names(colors) = c("PCovS", "NCovS", "PCovM", "NCovM", "PHC", "NHC")

colors1 = c(
  RColorBrewer::brewer.pal(9, "RdYlGn")[1],
  RColorBrewer::brewer.pal(9, "RdYlGn")[3],
  RColorBrewer::brewer.pal(9, "Blues")[7],
  RColorBrewer::brewer.pal(9, "Greens")[7]
)
names(colors1) = c("PCov", "NCov", "PHC", "NHC")
```

```{R fig.height=6, fig.width=12}
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_psi.rds")

markers = markers[markers$p_val_adj < 0.05, ]
markers$type = "Down"
markers$type[markers$deltaPSI > 0] = "Up"

markers$gene1 = sapply(markers$gene, function(x) {
  str_split(x, "\\|")[[1]][1]
})

temp = markers %>%
  dplyr::select(cell, group, type, gene1) %>%
  unique() %>%
  group_by(cell, group, type) %>%
  add_tally() %>%
  dplyr::select(cell, group, type, n) %>%
  unique() %>%
  as.data.frame()


temp$group = factor(
  str_replace_all(temp$group, "-(N|P)HC", ""),
  levels = c("PCovM", "PCovS", "NCovM", "NCovS")
)

temp$cell = factor(
  temp$cell,
  levels =c(
    "Class. mono", "Inter. mono", "Non-class. mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "erythroid", "platelet"
  )
)

temp = na.omit(temp)

temp$type = factor(temp$type, levels = c("Up", "Down"))

p <- ggplot(temp, aes(x=cell, fill = group, y = n, label = n)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_text(position = position_dodge(width = .9), angle = 90) +
  facet_grid(type~., scales = "free", space = "free") +
  theme_bw() +
  scale_fill_manual(values = colors) +
  labs(x="", y="The number of gene") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1),
    legend.position = "top"
  )

p

ggsave(
  filename = "/mnt/data5/zhangyiming/biye/markers_between_stages_psi_bar.pdf",
  plot = p, width = 10, height = 6
)
```


```{r}
library(clusterProfiler)
library(org.Hs.eg.db)
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_psi.rds")


go = list()
for (i in c("Class. mono", "Inter. mono", "Non-class. mono")) {
  print(i)
  data = list()
  temp = markers[markers$cell == i & markers$p_val_adj < 0.05 & abs(markers$deltaPSI) > .1, ]
  for (j in unique(temp$group)) {
    data[[j]] = sapply(temp$gene[temp$group == j], function(x) {
      str_split(x, "\\|")[[1]][1]
    })
  }
  go[[i]] = compareCluster(
    geneCluster = data, 
    fun = "enrichGO", 
    keyType="SYMBOL", 
    OrgDb = org.Hs.eg.db,
    ont = "BP"
  )
}

saveRDS(go, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_psi_go.rds")
```

```{r}
go_slim = list()
for (i in names(go)) {
  print(i)
  go_slim[[i]] = simplify(go[[i]])
}

saveRDS(go, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_psi_go_slim.rds")
```


```{r fig.height=8, fig.width=10}
library(RColorBrewer)

pdf("/mnt/data5/zhangyiming/biye/markers_between_stages_psi_go_slim.pdf", width = 10, height = 6)
for (i in names(go_slim)) {
  p <- dotplot(go_slim[[i]])
  p = p$data
  
  p$Cluster = str_replace_all(p$Cluster, "-(P|N)HC*", "")
  lvl = unique(p$Cluster)
  lvl = c(lvl[str_detect(lvl, "^P")], lvl[str_detect(lvl, "^N")])
  p$Cluster = factor(p$Cluster, levels = lvl)
  
  
  p <- ggplot(p, aes(x=Cluster, y=Description, size = Count, color = p.adjust)) +
    geom_point() +
    ggpubr::theme_pubr() +
    scale_color_gradient(
      high = brewer.pal(11, "RdYlBu")[10],
      low = brewer.pal(11, "RdYlBu")[2]
    ) + labs(title = i) +
    theme(legend.position = c(0, 0), legend.direction = "horizontal")
  print(p)
}
dev.off()
```


## CellType specific
```{r}
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes_tobit_celltype.rds")

temp = dcast(
  markers[markers$p_val_adj < 0.05, ], 
  gene~CellType, value.var = "deltaPSI", 
  fill = 0, fun.aggregate = mean
)

rownames(temp) <- temp$gene
temp = temp[, colnames(temp) != "gene"]


Heatmap(
  temp,
  name = "deltaPSI",
  cluster_columns = F,
  show_row_names = F,
  show_column_names = T,
  col  = colorRamp2(c(-1, 0, 1), c("blue", "lightgrey", "red")),
  column_names_gp = gpar(angle = 90),
  use_raster = T
)
```


```{r fig.height=4, fig.width=6}
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_celltypes_tobit_celltype.rds")

markers$type = "Down"
markers$type[markers$deltaPSI > 0] = "Up"
temp = markers[markers$p_val_adj < 0.05, ] %>%
  group_by(cluster, type) %>%
  add_tally() %>%
  dplyr::select(cluster, type, n) %>%
  unique() %>%
  as.data.frame()

temp$n[temp$type == "Down"] = temp$n[temp$type == "Down"] * -1


temp$cluster = factor(
  temp$cluster,
  levels =c(
    "Class. mono", "Inter. mono", "Non-class. mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "erythroid", "platelet"
  )
)


p <- ggplot(temp, aes(x=cluster, y=n, fill = type, label = abs(n))) +
  geom_bar(stat = "identity") +
  geom_text() +
  ggpubr::theme_pubr() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  labs(x="", y="Number of ATS", fill = "") +
  scale_fill_manual(values = c("Down"="#00AFBB", "Up"="#FC4E07")) 

p


ggsave(
  filename = "/mnt/data5/zhangyiming/biye/markers_between_celltypes_tobit.pdf",
  plot = p, width = 6, height = 4
)
```


```{r fig.height=4, fig.width=3}
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_lymphoid_myeloid.rds")

markers <- markers[markers$comp == "myeloid - lymphoid", ]


ggplot(markers, aes(x=deltaPSI, y=-log10(p_val_adj))) +
  geom_point()
```


```{r fig.height=4, fig.width=3}
markers <- readRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_psi.rds")

markers$group = factor(
  str_replace_all(markers$group, "-(N|P)HC", ""),
  levels = c("PCovM", "PCovS", "NCovM", "NCovS")
)

pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers_between_stages_deltapsi.pdf",  width = 3, height =  4)
for (i in unique(markers$cell)) {
  temp = markers[markers$cell == i & markers$p_val_adj < 0.05 & abs(markers$deltaPSI) > .1, ]
  
  temp = dcast(
    temp, 
    gene~group, value.var = "deltaPSI", 
    fill = 0, fun.aggregate = mean
  )

  temp$gene = sapply(temp$gene, function(x) {
    str_split(x, "\\|")[[1]][1]
  })
  temp = unique(temp)
  rownames(temp) <- make.unique(temp$gene)
  temp = temp[, colnames(temp) != "gene"]
  
  h = Heatmap(
    temp,
    name = "deltaPSI",
    cluster_columns = F,
    show_row_names = F,
    show_column_names = T,
    col  = colorRamp2(c(min(temp), 0, max(temp)), c("blue", "lightgrey", "red")),
    column_names_gp = gpar(angle = 90),
    use_raster = T,
    column_title = i,
    clustering_method_rows = "ward.D2"
  )
  draw(h)
}
dev.off()
```

```{r}
rownames(ICAS::psi(obj)) <-  sapply(rownames(ICAS::psi(obj)), function(x) {
  str_split(x, "\\|")[[1]][2]
})

GroupHeatSpot(object = obj, 
              SJ = "X:65667711-65667712:+", 
              low.col = "white", 
              BamFiles = c("/mnt/raid64/ATS/Personal/zhangyiming/bams/NCovM1.bam"), 
              geneModul = txdb, 
              logTrans = FALSE, 
              ignore.SEorPE = TRUE, 
              BamPostfix = "bam", 
              flank = 100, 
              reduce = FALSE, 
              rel_heights = c(1, 1, 1, 2.5), 
              shrinkage = 40)
```



```{R}
psi <- mcreadRDS("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/raw_psi.rds")
colnames(psi) <- str_replace_all(colnames(psi), ".psi", "")
meta = readRDS("/mnt/raid64/Covid19_Gravida/rds/meta_rm_doublets.rds")
meta = meta[!meta$CellType %in% c("HSC", "erythroid", "platelet"), ]

cells = intersect(colnames(psi), rownames(meta))

obj <- mcreadRDS("/mnt/raid64/Covid19_Gravida/rds/seurat_obj_rm_doublets_trqwe.rds")

obj <- subset(obj, cells=cells)

DimPlot(obj, group.by = "CellType")
```

```{r}
obj = FindVariableFeatures(obj, selection.method = "vst", nfeatures = 1000)
obj <- ScaleData(obj) # vg[!vg %in% markers$gene]
obj <- RunPCA(obj, features = VariableFeatures(obj))

ElbowPlot(obj)
```


```{r}
obj <- RunUMAP(obj, dims = 1:10, reduction.name = "test")
```

```{r}
DimPlot(obj, group.by = "CellType", reduction = "test")

mcsaveRDS(obj, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/seurat_obj_sel_trqwe.rds")
```


```{R}
obj <- trqwe::mcreadRDS("seurat_obj_sel_trqwe.rds")
mono <- trqwe::mcreadRDS("/mnt/raid64/Covid19_Gravida/rds/seurat_mono.rds")

cells = colnames(mono)[colnames(mono) %in% colnames(obj)]

obj@meta.data[cells, "CellType"] = mono@meta.data[cells, "CellType"]
```


```{r}
custom_fill_colors = c(
    RColorBrewer::brewer.pal(9, "Blues")[c(4, 6, 8, 9)],
    RColorBrewer::brewer.pal(9, "Greens")[4:7],
    RColorBrewer::brewer.pal(9, "YlGn")[1],
    RColorBrewer::brewer.pal(9, "Oranges")[c(2, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Reds")[c(1, 3, 5, 7)],
    RColorBrewer::brewer.pal(9, "Purples")[4:6],
    "grey75"
)
names(custom_fill_colors) <- c(
    "Class. mono", "Non-class. mono", "mDC", "pDC",
    "naïve B", "plasma B", "memory B", "HSC",
    "naïve CD8",  "naïve CD4", "CD8 memory",
    "CD8 CTL",  "NKT", "MAIT",  
    "Treg", "NK", "γδT",
    "Proliferative T",
    "platelet", "erythroid",
    "Inter. mono"
)


# names(custom_fill_colors) <- sort(unique(obj@meta.data$CellType))
umap = as.data.frame(obj@reductions$test@cell.embeddings)
colnames(umap) <- c("UMAP_1",  "UMAP_2")
umap$X2 = obj@meta.data[rownames(umap), "CellType"]
umap$group = as.character(obj@meta.data[rownames(umap), "recovery_stage"])
umap = umap[!umap$X2 %in% c("HSC", "platelet", "erythroid"), ]


pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/cell_types_expr.pdf", width  = 6, height = 6)
make_cell_types_plot3(
    umap,  
    group_by = "X2", 
    label = "X2",
    title = "",
    legend.position = "none",
    text_size = 5,
    colors = custom_fill_colors
)
dev.off()
```

```{R}
obj <- trqwe::mcreadRDS("seurat_obj_psi.rds")
mono <- trqwe::mcreadRDS("/mnt/raid64/Covid19_Gravida/rds/seurat_mono.rds")

cells = colnames(mono)[colnames(mono) %in% colnames(obj)]

obj@meta.data$CellType = as.character(obj@meta.data$CellType)
obj@meta.data[cells, "CellType"] = mono@meta.data[cells, "CellType"]
obj@meta.data$CellType[obj@meta.data$CellType == "CD14 mono"] = "Class. mono"
```


```{r}
# names(custom_fill_colors) <- sort(unique(obj@meta.data$CellType))
umap = as.data.frame(obj@reductions$umap@cell.embeddings)
colnames(umap) <- c("UMAP_1",  "UMAP_2")
umap$X2 = obj@meta.data[rownames(umap), "CellType"]
umap$group = as.character(obj@meta.data[rownames(umap), "recovery_stage"])
umap = umap[!umap$X2 %in% c("HSC", "platelet", "erythroid"), ]


pdf("/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/cell_types.pdf", width  = 6, height = 6)
make_cell_types_plot3(
    umap,  
    group_by = "X2", 
    label = "X2",
    title = "",
    legend.position = "none",
    text_size = 5,
    colors = custom_fill_colors
)
dev.off()
```



## CD16 and CD14 mono DEGs
```{r}
markers = NULL
library(doMC)
registerDoMC(4)
obj@meta.data$temp_group = paste(obj@meta.data$CellType, obj@meta.data$recovery_stage, sep = "|")
markers = foreach (i = c("PCovM", "PCovS", "NCovM", "NCovS"), .combine = "rbind") %dopar% {
  ctl = "NHC"
  if (i %in% c("PCovM", "PCovS")) {
    ctl = "PHC"
  }
  
  markers = NULL
  for (j in c("CD16 mono", "CD14 mono")) {
    temp = FindMarkers(
      obj, 
      group.by = "temp_group", 
      ident.1 = paste(j, i, sep = "|"), 
      ident.2 = paste(j, ctl, sep = "|"), 
      logfc.threshold = 0
    )
    temp$gene = rownames(temp)
    temp$group = i
    temp$cell = j
    
    markers = rbind(markers, temp)
  }

  return(markers)
}

saveRDS(markers, "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/expr_markers.rds")
```


```{R fig.height=4, fig.width=8}
temp = markers[markers$p_val_adj < 0.05 & abs(markers$avg_logFC) > .25, ]

temp = dcast(
  temp, gene+cell~group, 
  value.var = "avg_logFC", fill = 0, 
  fun.aggregate = mean
)


h <- Heatmap(
  t(temp[, c("PCovM", "PCovS", "NCovM", "NCovS")]),
  name = "avg_logFC",
  column_split = temp$cell,
  clustering_method_columns = "ward.D2",
  cluster_rows = F
)

co = column_order(h)

temp = temp[c(co[["CD16 mono"]], co[["CD14 mono"]]), ]

temp = rbind(
  temp[temp$cell == "CD16 mono", ],
  temp[temp$cell != "CD16 mono", ]
)

temp$cell = factor(temp$cell, levels = c("CD16 mono", "CD14 mono"))

h <- Heatmap(
  t(temp[, c("PCovM", "PCovS", "NCovM", "NCovS")]),
  name = "avg_logFC",
  column_split = temp$cell,
  clustering_method_columns = "ward.D2",
  cluster_rows = F,
  cluster_columns = F,
  border = T,
  use_raster = T,
  show_column_names = F,
  col = colorRamp2(c(-1, 0, 1), c("blue", "grey75", "red"))
)

pdf("avg_logFC_heat.pdf", width = 8, height = 4)
draw(h)
dev.off()
```



```{R fig.height=6, fig.width=8}
temp = markers[markers$p_val_adj < 0.05 & abs(markers$avg_logFC) > .25, ]

go = list()
for (i in c("CD16 mono", "CD14 mono")) {
  gene = list()
  for (j in unique(temp$group)) {
    gene[[j]] = temp$gene[temp$cell == i & temp$group == j]
  }
  
  go[[i]] = compareCluster(
    geneCluster = gene, 
    fun = "enrichGO", 
    keyType="SYMBOL", 
    OrgDb = org.Hs.eg.db,
    ont = "BP"
  )
}


pdf("expr_go.pdf", width = 8, height = 6)
for(i in names(go)) {
  p <- dotplot(go[[i]]) + labs(title = i)
  print(p)
}
dev.off()

```


```{r fig.height=6, fig.width=9}
markers <- read.xlsx("/mnt/raid64/Covid19_Gravida/cluster.xlsx", rowNames = T) # _20210104

markers <- markers[
  c(
    "CD79A", "MS4A1", "MZB1", "CD3E", "CD4",  "CD8A", "CCR7", "SELL", "FOXP3",
    "TRAV1-2", "TRGV9", "TRDV2", "MKI67", "GPR183", "GZMK",
    "GZMA", "GZMB", "GNLY", "PRF1", "NKG7", "LYZ",  "CD14", "FCGR3A", "CD1C",
    "CLEC4C", "PPBP"
  ),
  c("naïve.B", "memory.B", "plasma.B", 
    "naïve.CD4", "naïve.CD8", "Treg", "MAIT", "γδT",
    "Proliferative.T", "CD8.memory", "CD8.CTL", "NKT",      
    "NK", "CD14.mono",
    "CD16.mono", "mDC", "pDC")
]


obj@meta.data$CellType = factor(
    as.character(obj@meta.data$CellType), 
    levels = c("naïve B", "memory B", "plasma B", 
      "naïve CD4", "naïve CD8", "Treg", "MAIT", "γδT",
      "Proliferative T", "CD8 memory", "CD8 CTL", "NKT",      
      "NK", "Class. mono", "Inter. mono",
      "Non-class. mono", "mDC", "pDC"
  )
)

p <- DotPlot(obj, group.by = "CellType", features = rownames(markers), dot.scale = 8) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) 

p

ggsave(
  filename = "/mnt/raid64/ATS/Personal/zhangyiming/quant/R_sel/markers.pdf",
  plot = p, width = 9, height = 6  
)
```




Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
